The File Format
===============

The file format is block oriented, similar like common image formats (e.g. PNG). It uses a magic header, and blocks with
a four byte identifier and 64bit size field. Even this base is modular, the format is strict in types and ordering of
the blocks in the sake of speed and security.

Overall Structure
-----------------

- 8 bytes with magic `0xfe`, `FFE`, `0x0d`, `0x0a`, `0x1a`, `0x0a`
- n data blocks with the following format:
  - 4 bytes with the block type.
  - 8 bytes with the size of the block. Big-endian, unsigned, 64-bit.
  - n bytes with the data of the block.

Block Types and Correct Order
-----------------------------

### `CONF` Encryption configuration (maximum size 128 bytes)

`k:RSA-4096,e:AES-256,b:CBC,h:SHA3-512,v:1`

comma separated fields "<key>:<value>", the fields must be specified appear in the shown order:

- `k` key algorithm
- `e` encryption algorithm
- `b` block algorithm
- `h` hash algorithm
- `v` file format version

  This field can be validated to match any expected encryption. There is no need to allow other algorithms, if values in
  the configuration differ. It is safe to stop decoding with an error.

### `EPUB` Encryption Key Hash (maximum size 1k)

The hash for the used public key to encrypt the symmetric key. This hash is generated by using a SHA3-512 hash on the
DER encoded public key in SubjectPublicKeyInfo format.

### `ESYM` Encrypted Symmetric Key (maximum size 1k)

For RSA-4096: The symmetric key is encrypted using OAEP padding, with the given hash size and no label.

### `META` Encrypted metadata (maximum size 10k)

The block with the encrypted metadata.

If no metadata is given, this block and the hash block is empty.

### `MDHA` Hash for metadata (maximum size 1k)

The hash for the decrypted metadata. Encrypted.

### `DATA` Encrypted file data (no maximum size)

The encrypted file data.

For empty files with a size of zero, this block and the hash block is empty.

### `DTHA` Hash for the decrypted data.

The hash for the decrypted file data. Encrypted.

### `ENDH` = End of file with hash

Marks the end of the file and contains a SHA3-512 hash for the whole file, up to this block, without the bytes of the
block type. The bytes following this block type are therefore always 0x40,0,0,0,0,0,0,0 for a 64 byte sized block,
followed by the 64 byte hash.

In order to quickly check the integrity of a file, you can create a digest of the file data up to
`file_size - 76 bytes`, then skip 12 bytes, read the next 64 and compare the digest.

### `ENDS` = End of streamed file

Marks the end of a streamed file that contains no SHA3-512 hash for the whole file. The bytes following this block type
are always 0x40,0,0,0,0,0,0,0 for a 64 byte sized block, followed by the 64 zero bytes. This zero bytes are added to
allow a quick verification of files which contain a hash using a seek operation (see `ENDH`).

A file always ends in a `ENDH` or `ENDS` block. There must be no other block following the end blocks.

### Block Order

The blocks must appear in the shown order. Especially the first configuration block. In future extensions, different
configurations and versions may require different ordering of the blocks.

Encrypted Data Block Format
---------------------------

The data format in an encrypted data block:

- 8 bytes, big endian, unsigned, with the size of the decrypted data.
  - If the encrypted file is empty, the *block* is empty and this size is not given.
  - If this value is greater than zero, it is the size of the decrypted data in bytes.
- 16 bytes (for AES-256/CBC) with the IV for the encryption
- The encrypted data, aligned to the cipher block size.

If the encrypted data is empty, this block is empty.

Metadata Format
---------------

- Each file can contain a custom block with metadata.
- The metadata is stored as a UTF-8 encoded block in JSON format.
- The JSON block must be stored compact, without pretty formatting.
- The JSON block must encode a top level object like this:

```json
{
  "attribute1": "data2",
  "attribute2": "data2",
  "attribute3": "data3"
}
```

- So there has to be an object with attributes (no top-level list, etc.), but the format of the attribute is user
  defined and can contain lists and nested objects.
- The size of the encrypted metadata must not exceed 100k.
- Field names only consist of lowercase letters and the underscore character. They must be shorter than 64 characters.

Predefined Metadata Fields
--------------------------

- `file_path` The original absolute path of the encrypted file.
- `file_name` The original filename of the encrypted file.
- `file_size` The original size of the encrypted file.
- `created` The original created UTC date/time in ISO format (yyyy-mm-ddThh:mm:ss)
- `modified` The original modified UTC date/time in ISO format (yyyy-mm-ddThh:mm:ss)
- `mime_type` The MIME type of the file contents.
- `version` A version of the file, free format.
- `encryptor` The name of the application which encrypted the file.

Error Handling on Decoding
--------------------------

If there is a problem, decoding shall simply stop. Do not try recover from the problem.

- If the file is smaller than 256 bytes, it is invalid, stop decoding.
- If an unknown block type field is read, stop decoding.
- If an expected block is missing, stop decoding.
- If the size of the block, exceeds the specified size, stop decoding.
- If the `CONF` field do not match the exact encryption specification, stop decoding.
- If the hash does not match the decoded data, stop decoding.

